---
title: "building a multi-llm plan critique system for claude code"
description: "how i built a hook that sends plans through gemini and codex before letting claude implement anything."
date: "2026-01-10"
tags: ["claude-code", "hooks", "gemini", "codex", "engineering"]
published: true
---

one model has blind spots. always. i've watched gemini catch architectural issues codex missed, and codex catch edge cases gemini glossed over. when they disagree, that's signal.

this is a deep dive into how i built a claude code hook that sends plans through multiple llms before implementation starts.

![planning vibes](https://media.giphy.com/media/3o7btPCcdNniyf0ArS/giphy.gif)

## the goal

when claude creates an implementation plan, i want:

1. **test-first enforcement.** block if no test files listed
2. **gemini 3 flash critique.** architectural review, coverage gaps
3. **codex second opinion.** what did gemini miss?
4. **all feedback visible to claude** before implementation starts

## how claude code hooks work

hooks are commands that run at specific points in claude's workflow. the one i care about is `PostToolUse`. runs after a tool completes.

in `~/.claude/settings.json`:

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "ExitPlanMode",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/hooks/critique-plan.sh",
            "timeout": 600
          }
        ]
      }
    ]
  }
}
```

this triggers my script whenever claude exits plan mode (i.e., the plan is ready for approval).

## the architecture

<ThemedImage
  lightSrc="/diagrams/multi-llm-critique-light.png"
  darkSrc="/diagrams/multi-llm-critique-dark.png"
  alt="Multi-LLM plan critique workflow showing Claude, Gemini, and Codex phases"
/>

## the hard parts

### problem 1: blocking doesn't work with json

my first attempt returned:

```json
{
  "decision": "block",
  "reason": "TEST-FIRST VIOLATION: Plan rejected..."
}
```

claude code said "hook succeeded" and kept going. the `decision: block` was ignored.

**fix:** use exit code 2 + stderr instead:

```bash
# this gets ignored
cat << EOF
{"decision": "block", "reason": "..."}
EOF
exit 0

# this actually blocks
cat >&2 << EOF
TEST-FIRST VIOLATION - Plan Rejected
...
EOF
exit 2
```

exit code 2 signals "hook blocked this action" and stderr content becomes the message claude sees.

### problem 2: background processes are useless

i tried running the llm critiques in the background:

```bash
( ... gemini ... codex ... ) &
```

hook returned immediately. critique ran in the background. claude never saw it because the hook was already done.

**fix:** make it synchronous. yes, it takes 20-30 seconds. worth it.

```bash
# blocking - claude waits and sees the result
GEMINI_RESULT=$(opencode run -m "openrouter/google/gemini-3-flash-preview" "$PROMPT")
CODEX_RESULT=$(codex exec --full-auto "$PROMPT")
```

### problem 3: plan freshness

the hook reads the most recent plan file from `~/.claude/plans/`. but if the user takes too long reviewing, the plan gets "stale" and the hook silently exits:

```
Plan age: 288s (max 120s)
EXIT: Plan too old
```

claude sees "hook succeeded" and proceeds.

**partial fix:** increased timeout to 600s. better fix would be reading from `tool_response.plan` in the hook input instead of relying on file timestamps.

## the code

here's the main hook script. it's messy but it works.

```bash
#!/bin/bash
set -euo pipefail

DEBUG_LOG="$HOME/.claude/logs/critique-hook.log"
mkdir -p "$(dirname "$DEBUG_LOG")"

log_debug() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$DEBUG_LOG"
}

# find most recent plan file
PLAN_FILE=$(ls -t ~/.claude/plans/*.md 2>/dev/null | head -1)

if [[ ! -f "$PLAN_FILE" ]]; then
    exit 0  # no plan, nothing to do
fi

# freshness check
PLAN_AGE=$(($(date +%s) - $(stat -f %m "$PLAN_FILE")))
if [[ $PLAN_AGE -gt 600 ]]; then
    exit 0  # too old, skip
fi

PLAN_CONTENT=$(cat "$PLAN_FILE")

# test-first check (separate script)
TEST_CHECK=$(echo "$PLAN_CONTENT" | ~/.claude/hooks/test-first-check.sh)
TEST_PASSED=$(echo "$TEST_CHECK" | jq -r '.passed')

if [[ "$TEST_PASSED" == "false" ]]; then
    ISSUES=$(echo "$TEST_CHECK" | jq -r '.issues | join("\n- ")')
    cat >&2 << EOF
TEST-FIRST VIOLATION - Plan Rejected

Issues:
- $ISSUES

Fix: Add test files BEFORE implementation files in your plan.
EOF
    exit 2
fi

# gemini critique
GEMINI_PROMPT="You are a senior architect reviewing an implementation plan...
$PLAN_CONTENT"

GEMINI_RESULT=$(opencode run -m "openrouter/google/gemini-3-flash-preview" "$GEMINI_PROMPT" 2>/dev/null || echo "[unavailable]")

# codex reviews gemini's critique
CODEX_PROMPT="Review this plan AND Gemini's critique. What did Gemini miss?
---
PLAN:
$PLAN_CONTENT
---
GEMINI'S CRITIQUE:
$GEMINI_RESULT"

CODEX_RESULT=$(codex exec --full-auto "$CODEX_PROMPT" 2>/dev/null || echo "[unavailable]")

# return to claude
FULL_CRITIQUE="PLAN CRITIQUE FROM GEMINI + CODEX

## Gemini 3 Flash
$GEMINI_RESULT

## Codex
$CODEX_RESULT"

jq -n --arg ctx "$FULL_CRITIQUE" '{
  "hookSpecificOutput": {
    "hookEventName": "PostToolUse",
    "additionalContext": $ctx
  }
}'
```

## what the critiques look like

here's an actual critique from a recent plan:

**gemini:**
> **Test Coverage (PRIMARY CRITIQUE - INSUFFICIENT)**
> While the plan includes `collection-viewer.test.ts`, it has significant gaps:
> - Missing Add Page Tests: You modify `src/app/collection/[id]/add/page.tsx` but provide no corresponding test file.
> - Null Safety: `currentAndeeTag` can now be `null`. Tests must verify sub-components don't crash.

**codex:**
> - Missed test scenario: `?viewer=` present but `useCurrentAndee` reports authenticated; ensure viewer override wins
> - Test quality issue: `page.test.tsx` uses `vi.mock` inside tests; this won't rewire imports after module is loaded

they catch different things. that's the point.

## what's missing

things i'd improve:

1. **read plan from hook input** instead of filesystem (avoids staleness issues)
2. **add confidence weights.** if both models agree on an issue, flag it higher
3. **auto-apply suggestions.** generate a diff for test files mentioned in critiques
4. **more models.** gpt-4o, claude itself reviewing its own plan

## related

- [my overall ai coding workflow](/posts/the-system)
- [test-first enforcement](/posts/test-first-enforcement). the validator script
- the test-first-check.sh script details (coming soon)

---

the hook code lives in my dotfiles. still iterating on it.
